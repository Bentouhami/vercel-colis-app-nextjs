@startuml MCD_ColisApp_Conceptuel_Complet
!theme vibrant
title MCD ColisApp - Modèle Conceptuel de Données (Notation Merise)
allowmixing
skinparam entity {
  backgroundColor White
  borderColor Black
}
skinparam usecase {
  BorderColor Black
  BackgroundColor LightYellow
  FontSize 12
}

' Enumérations
enum Role {
  CLIENT
  SUPER_ADMIN
  DESTINATAIRE
  AGENCY_ADMIN
  ACCOUNTANT
}

enum PaymentMethod {
  CARD
  CASH
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum VatType {
  REDUCED
  STANDARD
  EXEMPT
}

enum AddressType {
  HOME
  OFFICE
  BILLING
  SHIPPING
  OTHER
}

enum SimulationStatus {
  DRAFT
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum EnvoiStatus {
  PENDING
  SENT
  DELIVERED
  CANCELLED
  RETURNED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  RESCHEDULED
  COMPLETED
  MISSED
  IN_PROGRESS
}

enum TrackingEventStatus {
  CREATED
  COLLECTED
  IN_TRANSIT
  ARRIVED_AT_AGENCY
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
}

enum ActivityType {
  AGENCY_CREATED
  AGENCY_UPDATED
  CLIENT_LINKED
  ENVOI_CREATED
  PAYMENT_CREATED
}

' --- ENTITÉS ---
entity User {
  firstName
  lastName
  email
  phoneNumber
  password
  role
  isVerified
  isEnterprise
  birthDate
}

entity Account {
  type
  provider
  providerAccountId
  refresh_token
  access_token
}

entity Session {
  sessionToken
  expires
}

entity PasswordResetToken {
  token
  expiresAt
}

entity Address {
  street
  complement
  streetNumber
  boxNumber
}

entity City {
  name
  latitude
  longitude
}

entity Country {
  name
  iso2
  iso3
  phonecode
  capital
  currency
}

entity Timezone {
  zoneName
  gmtOffset
  abbreviation
}

entity VatRate {
  vatPercent
  vatType
}

entity Agency {
  name
  location
  phoneNumber
  email
  vatNumber
  capacity
  availableSlots
}

entity ActivityLog {
  activityType
  details
  staffRole
}

entity Envoi {
  trackingNumber
  qrCodeUrl
  simulationStatus
  envoiStatus
  totalWeight
  totalVolume
  totalPrice
  paid
  departureDate
  arrivalDate
  comment
}

entity Parcel {
  height
  weight
  width
  length
}

entity Payment {
  method
  status
  amount
  transactionId
}

entity TrackingEvent {
  eventStatus
  location
  description
}

entity Transport {
  number
  baseVolume
  baseWeight
  currentVolume
  currentWeight
  isAvailable
}

entity TransportSchedule {
  departureDate
  arrivalDate
  isHoliday
}

entity Appointment {
  date
  status
}

entity Tarifs {
  weightRate
  volumeRate
  baseRate
  fixedRate
}

entity Coupon {
  couponCode
  discountAmount
  discountPercentage
  numberOfUses
  startDate
  expirationDate
}

entity Notification {
  message
  isRead
}

entity Authenticator {
  credentialID
  credentialPublicKey
  counter
}

entity HabiteA {
  addressType
  createdAt
  updatedAt
  isDeleted
}

' --- ASSOCIATIONS (ovales) ---
usecase "(A pour compte)" as ACompte
usecase "(A pour session)" as ASession
usecase "(A pour token reset)" as ATokenReset
usecase "(A pour authenticator)" as AAuthenticator
usecase "(Se trouve dans)" as SeTrouveDans
usecase "(Fait partie de)" as FaitPartieDe
usecase "(A pour fuseau)" as AFuseau
usecase "(A pour TVA)" as ATVA
usecase "(Crée)" as Cree
usecase "(Est client de)" as ClientDe
usecase "(Effectue activité)" as EffectueActivite
usecase "(Envoie)" as Envoie
usecase "(Reçoit)" as Recoit
usecase "(Part de)" as PartDe
usecase "(Arrive à)" as ArriveA
usecase "(Utilise transport)" as UtiliseTransport
usecase "(Contient)" as Contient
usecase "(Règle)" as Regle
usecase "(A pour historique)" as Historique
usecase "(A rendez-vous)" as ARendezVous
usecase "(Bénéficie coupon)" as BeneficieCoupon
usecase "(Utilise coupon)" as UtiliseCoupon
usecase "(Reçoit notification)" as RecoitNotification
usecase "(Concerne envoi)" as ConcerneEnvoi
usecase "(Est localisée à)" as LocaliseeA
usecase "(Applique)" as Applique
usecase "(A pour planning)" as APourPlanning
usecase "(Gère)" as Gere

' New associations
usecase "(Est Client/Destinataire de)" as EstClientDestinataireDe
usecase "(Est Membre du Personnel)" as EstMembrePersonnel
EstMembrePersonnel : staffRole

' --- RELATIONS PRINCIPALES ---

' User et ses comptes/sessions
User "1,1" -- ACompte : a pour compte
ACompte -- "0,n" Account : est associé à

User "1,1" -- ASession : a pour session
ASession -- "0,n" Session : est associé à

User "1,1" -- ATokenReset : a pour token de réinitialisation
ATokenReset -- "0,n" PasswordResetToken : est associé à

User "1,1" -- AAuthenticator : a pour authentificateur
AAuthenticator -- "0,n" Authenticator : est associé à

' User et adresses
User "1,n" -- HabiteA : habite à
HabiteA -- "0,n" Address : est une adresse de

' Hiérarchie géographique
Address "1,n" -- SeTrouveDans : se trouve dans
SeTrouveDans -- "1,1" City : est associée à

City "1,n" -- FaitPartieDe : fait partie de
FaitPartieDe -- "1,1" Country : est associée à

Country "1,1" -- AFuseau : a pour fuseau horaire
AFuseau -- "0,n" Timezone : est associée à

Country "1,1" -- ATVA : applique TVA
ATVA -- "0,n" VatRate : est associée à

' User et Agency
User "0,1" -- Cree : crée
Cree -- "0,n" Agency : est créée par

User "0,n" -- ClientDe : est client de
ClientDe -- "0,n" Agency : a pour client

' New Client/Destinataire association
User "0,n" -- EstClientDestinataireDe : est client/destinataire de
EstClientDestinataireDe -- "0,n" User : a pour client/destinataire

' New AgencyStaff association
User "0,n" -- EstMembrePersonnel : est membre du personnel
EstMembrePersonnel -- "0,n" Agency : a pour agence

User "0,1" -- EffectueActivite : effectue activité
EffectueActivite -- "0,n" ActivityLog : est associée à

Agency "0,1" -- EffectueActivite : concerne activité

' Envois
User "1,1" -- Envoie : envoie
Envoie -- "0,n" Envoi : est envoyé par

User "1,1" -- Recoit : reçoit
Recoit -- "0,n" Envoi : est reçu par

Agency "1,1" -- PartDe : part de
PartDe -- "0,n" Envoi : est le point de départ de

Agency "1,1" -- ArriveA : arrive à
ArriveA -- "0,n" Envoi : est le point d'arrivée de

Envoi "0,n" -- UtiliseTransport : utilise
UtiliseTransport -- "0,1" Transport : est utilisé par

' Parcels et Envois
Envoi "1,1" -- Contient : contient
Contient -- "1,n" Parcel : est contenu dans

' Payment
Envoi "1,1" -- Regle : règle
Regle -- "0,1" Payment : est réglé pour

' Tracking
Envoi "1,1" -- Historique : a pour historique
Historique -- "0,n" TrackingEvent : est un événement de

' Appointments
Envoi "1,1" -- ARendezVous : a rendez-vous
ARendezVous -- "0,1" Appointment : est un rendez-vous pour

Agency "1,1" -- ARendezVous : gère rendez-vous

' Coupons
User "0,n" -- BeneficieCoupon : bénéficie
BeneficieCoupon -- "0,n" Coupon : est bénéficié par

Envoi "0,n" -- UtiliseCoupon : utilise
UtiliseCoupon -- "0,n" Coupon : est utilisé par

' Notifications
User "0,1" -- RecoitNotification : reçoit
RecoitNotification -- "0,n" Notification : est reçue par

Envoi "1,1" -- ConcerneEnvoi : concerne envoi
ConcerneEnvoi -- "0,n" Notification : est associée à

Agency "1,1" -- ConcerneEnvoi : concerne agence

' Agency et services
Agency "1,1" -- LocaliseeA : localisée à
LocaliseeA -- "1,1" Address : est l'adresse de

Agency "0,1" -- Applique : applique
Applique -- "1,n" Tarifs : est appliquée par

Agency "0,1" -- Gere : gère
Gere -- "0,n" Transport : est géré par

Transport "1,1" -- APourPlanning : a pour planning
APourPlanning -- "0,n" TransportSchedule : est un planning de

@enduml